/* Map Component by Misol. (c) 2011 MinSoo Kim. (misol.kr@gmail.com) */
var map_zoom=13,map_lat="",map_lng="",marker_latlng="",marker_ment="",map="",marker="",saved_location=new Array(),result_array=new Array(),infowindow="",result_from="";function soo_save_location(c,a){c=parseInt(c,10);if(a!=1){saved_location[c]=new Array();saved_location[c][0]=map.getZoom();saved_location[c][1]=map.getCenter().lat();saved_location[c][2]=map.getCenter().lng();saved_location[c][3]=marker_latlng.lat();saved_location[c][4]=marker_latlng.lng();saved_location[c][5]=jQuery("#ment").val()}var b='<form action="#" onsubmit="soo_save_location(this.locations.value); return false" id="form_to_save"><select size="1" id="locations">',d=0;for(d=0;d<saved_location.length;d++){if(d==c){b+='<option value="'+d+'" selected="selected">'+(d+1)+"["+soo_editing+"]</option>"}else{b+='<option value="'+d+'">'+(d+1)+"</option>"}}b+='<option value="'+d+'">'+(d+1)+"</option>";b+='</select><br /><span class="button red"><input id="save_btn" type="submit" value="'+soo_save+'" /></span> <span class="button"><button type="button" onclick="soo_load_location();">'+soo_edit+"</button></span></form>";jQuery("#save_form").html(b)}function soo_load_location(){var b=document.getElementById("form_to_save");var a=b.locations.selectedIndex;a=parseInt(a,10);if(!saved_location[a]){alert(soo_nulledit);return}jQuery("#map_zoom").val(saved_location[a][0]);jQuery("#lat").val(saved_location[a][1]);jQuery("#lng").val(saved_location[a][2]);jQuery("#ment").val(saved_location[a][5]);map_zoom=parseInt(jQuery("#map_zoom").val(),10);center=new google.maps.LatLng(saved_location[a][1],saved_location[a][2]);map.setCenter(center);map.setZoom(map_zoom);marker.setMap(null);marker_latlng=new google.maps.LatLng(saved_location[a][3],saved_location[a][4]);marker=new google.maps.Marker({position:marker_latlng,map:map,draggable:true});soo_marker_event();marker.setMap(map);infowindow.close();infowindow=new google.maps.InfoWindow({content:dragmarkertext+"<br /><strong>"+saved_location[a][5]+"</strong>",disableAutoPan:true});infowindow.open(map,marker);soo_save_location(a,1)}function map_point(a){map_zoom=parseInt(jQuery("#map_zoom").val(),10);center=result_array[a].geometry.location;map.setCenter(center);latlng=center;marker.setMap(null);marker_latlng=result_array[a].geometry.location;marker=new google.maps.Marker({position:marker_latlng,map:map,draggable:true});soo_marker_event();marker.setMap(map);infowindow.close();infowindow=new google.maps.InfoWindow({content:dragmarkertext+"<br /><strong>"+result_array[a].formatted_address+"</strong>",disableAutoPan:true});infowindow.open(map,marker)}function view_list(){var b="";for(var a=0;a<result_array.length;a++){if(a==0){b+='<ul id="view_list">'}if(result_array.length==1){map_point("0")}b+='<li class="result_lists"><a href="javascript:map_point(\''+a+"');\">"+result_array[a].formatted_address+"</a>";if(typeof(result_array[a].from)=="undefined"){b+=" by Google</li>"}else{b+=" by "+result_array[a].from+"</li>"}}if(result_from=="naver"){b+='<li class="result_lists"><p>Address result powered by<br />- <strong>Google API</strong><br />- <strong>Yahoo Maps</strong><br />- <img src="http://openapi.naver.com/logo/logo07_1.gif" alt="NAVER OpenAPI" /></p></li>'}else{if(result_from=="google"){b+='<li class="result_lists"><p>Address search by <strong>Google API</strong>.</p></li>'}}b+="</ul>";jQuery("#result_list_layer").html(b);window.location.href="#view_list"}function addAddressToMap(b,a){if(a==200){result_from="naver"}else{if(a==google.maps.GeocoderStatus.OK){result_from="google"}}if(a!=google.maps.GeocoderStatus.OK&&a!=200){alert(no_result+"\nGoogle Error Code : "+a)}else{result_array=new Array();result_array=b;view_list()}}function showLocation(a){result_from="";if(naver_api_check==1){if(!a){return}var c=new Array();c.component="soo_google_map";c.address=a;c.method="search";var b=new Array("error","message","results");exec_xml("editor","procEditorCall",c,function(e,d){complete_search(e,d,a)},b)}else{geocoder.geocode({address:a},function(e,d){addAddressToMap(e,d)})}}function complete_search(c,d,a){var b=c.results;if(b){b=b.item}else{b=new Array()}geocoder.geocode({address:a},function(f,e){address_adder(f,e,a,b)})}function address_adder(f,d,e,l){var c=new Array(),g=new Array();if(d!=google.maps.GeocoderStatus.OK){c=new Array()}else{c=f;g=f}var h=c.length;for(var k=0;k<l.length;k++){if(l[k].formatted_address||l[k].formatted_address!=null){g[h]={from:l[k].result_from,formatted_address:l[k].formatted_address,geometry:{location:new google.maps.LatLng(l[k].geometry.lat,l[k].geometry.lng)}};h++}}addAddressToMap(g,200)}function soo_marker_event(){google.maps.event.addListener(marker,"dragstart",function(){infowindow.close()});google.maps.event.addListener(marker,"dragend",function(a){if(a.latLng){geocoder.geocode({latLng:a.latLng},function(c,b){if(b==google.maps.GeocoderStatus.OK){if(c[1]){infowindow.close();infowindow=new google.maps.InfoWindow({content:dragmarkertext+"<br />"+c[1].formatted_address});infowindow.open(map,marker)}else{infowindow.close();infowindow=new google.maps.InfoWindow({content:dragmarkertext});infowindow.open(map,marker)}}});marker_latlng=a.latLng}})}function getGoogleMap(){var b={zoom:8,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("map_canvas"),b);if(typeof(opener)=="undefined"){return}var e=opener.editorPrevNode;infowindow=new google.maps.InfoWindow();if(e&&e.nodeName=="IMG"){jQuery("#width").val(jQuery(e).width());jQuery("#height").val(jQuery(e).height());if(!e.getAttribute("location_no")){map_lat=e.getAttribute("map_lat");map_lng=e.getAttribute("map_lng");marker_lat=e.getAttribute("marker_lat");marker_lng=e.getAttribute("marker_lng");marker_latlng=new google.maps.LatLng(marker_lat,marker_lng);latlng=marker_latlng;map_zoom=parseInt(e.getAttribute("map_zoom"),10);marker_ment=e.getAttribute("ment");marker_ment=marker_ment.replace(/\[\[STS\[\[/g,"<");marker_ment=marker_ment.replace(/\]\]STS\]\]/g,">");marker_ment=marker_ment.replace(/\[\[STS_EQ\]\]/g,"=");if(marker_latlng){latlng=marker_latlng}if(map_zoom){jQuery("#map_zoom").val(map_zoom)}if(map_lat){jQuery("#lat").val(map_lat)}if(map_lng){jQuery("#lng").val(map_lng)}if(marker_ment){jQuery("#ment").val(marker_ment)}}else{var f=parseInt(e.getAttribute("location_no"),10),d='<form action="#" onsubmit="soo_save_location(this.locations.value); return false" id="form_to_save"><select size="1" id="locations">',c=0;for(c=0;c<f;c++){saved_location[c]=new Array();saved_location[c][0]=e.getAttribute("map_zoom"+c);saved_location[c][1]=e.getAttribute("map_lat"+c);saved_location[c][2]=e.getAttribute("map_lng"+c);saved_location[c][3]=e.getAttribute("marker_lat"+c);saved_location[c][4]=e.getAttribute("marker_lng"+c);saved_location[c][5]=e.getAttribute("ment"+c);saved_location[c][5]=saved_location[c][5].replace(/\[\[STS\[\[/g,"<");saved_location[c][5]=saved_location[c][5].replace(/\]\]STS\]\]/g,">");saved_location[c][5]=saved_location[c][5].replace(/\[\[STS_EQ\]\]/g,"=");if(c==0){d+='<option value="'+c+'" selected="selected">'+(c+1)+"["+soo_editing+"]</option>"}else{d+='<option value="'+c+'">'+(c+1)+"</option>"}}d+='<option value="'+c+'">'+(c+1)+"</option>";d+='</select><br /><span class="button red"><input id="save_btn" type="submit" value="'+soo_save+'" /></span> <span class="button"><button type="button" onclick="soo_load_location();">'+soo_edit+"</button></span></form>";jQuery("#save_form").html(d);map_lat=saved_location[0][1];map_lng=saved_location[0][2];marker_lat=saved_location[0][3];marker_lng=saved_location[0][4];marker_latlng=new google.maps.LatLng(marker_lat,marker_lng);latlng=marker_latlng;map_zoom=parseInt(saved_location[0][0],10);marker_ment=saved_location[0][5];if(marker_latlng){latlng=marker_latlng}if(map_zoom){jQuery("#map_zoom").val(map_zoom)}if(map_lat){jQuery("#lat").val(map_lat)}if(map_lng){jQuery("#lng").val(map_lng)}if(marker_ment){jQuery("#ment").val(marker_ment)}}map.setCenter(new google.maps.LatLng(map_lat,map_lng));map.setZoom(map_zoom);var a=map.getCenter()}else{jQuery("#lat").val(defaultlat);map_lat=defaultlat;jQuery("#lng").val(defaultlng);map_lng=defaultlng;map.setCenter(new google.maps.LatLng(map_lat,map_lng));var a=map.getCenter();marker_latlng=a;jQuery("#width").val("600");jQuery("#height").val("400");jQuery("#ment").val("");latlng=a}soo_map_set();map.setZoom(map_zoom);google.maps.event.addListener(map,"dragend",function(){a=map.getCenter();jQuery("#lng").val(a.lng());jQuery("#lat").val(a.lat());jQuery("#map_zoom").val(map.getZoom());var i=map.getBounds();var h=i.getSouthWest();var g=i.getNorthEast();if((latlng.lng()<h.lng()||g.lng()<latlng.lng())||(latlng.lat()<h.lat()||g.lat()<latlng.lat())){marker.setMap(null);infowindow.close();latlng=a;marker_latlng=latlng;marker=new google.maps.Marker({position:a,map:map,draggable:true});marker.setMap(map);infowindow=new google.maps.InfoWindow({content:dragmarkertext,disableAutoPan:true});infowindow.open(map,marker);soo_marker_event()}});marker=new google.maps.Marker({position:latlng,map:map,draggable:true});soo_marker_event();marker.setMap(map);geocoder=new google.maps.Geocoder();jQuery("#lng").val(a.lng());jQuery("#lat").val(a.lat());jQuery("#map_zoom").value=map.getZoom();marker_latlng=latlng;infowindow.close();if(marker_ment){infowindow=new google.maps.InfoWindow({content:marker_ment,disableAutoPan:true});infowindow.open(map,marker)}}function insertMap(e){if(typeof(opener)=="undefined"){return}var c=jQuery("#width").val(),a=jQuery("#height").val();if(saved_location.length==0||saved_location.length==1){var h=jQuery("#ment").val();h=h.replace(/</g,"[[STS[[");h=h.replace(/>/g,"]]STS]]");h=h.replace(/=/g,"[[STS_EQ]]");h=h.replace("ment","");map_zoom=map.getZoom();map_lat=map.getCenter().lat();map_lng=map.getCenter().lng();if(!c){c="600"}if(!a){a="400"}if(!map_zoom){map_zoom="13"}if(insert_lat||insert_lng){if(insert_lat){if(typeof(opener.document.getElementsByName(insert_lat)[0])!="undefined"){var g=opener.document.getElementsByName(insert_lat)[0].value;if(typeof(g)=="string"){opener.document.getElementsByName(insert_lat)[0].value=map_lat}}}if(insert_lng){if(typeof(opener.document.getElementsByName(insert_lng)[0])!="undefined"){var g=opener.document.getElementsByName(insert_lng)[0].value;if(typeof(g)=="string"){opener.document.getElementsByName(insert_lng)[0].value=map_lng}}}}var f='<img src="https://maps-api-ssl.google.com/maps/api/staticmap?center='+map_lat+","+map_lng+"&zoom="+map_zoom+"&size="+c+"x"+a+"&markers=size:mid|"+marker_latlng.lat()+","+marker_latlng.lng()+'&sensor=false" editor_component="soo_google_map" ment="'+h+'" map_lat="'+map_lat+'" map_lng="'+map_lng+'" marker_lng="'+marker_latlng.lng()+'" marker_lat="'+marker_latlng.lat()+'" map_zoom="'+map_zoom+'" width="'+c+'" height="'+a+'" style="width:'+c+"px;height:"+a+"px;border:2px dotted #FF0033;background:url('https://maps-api-ssl.google.com/maps/api/staticmap?language="+soo_langcode+"&amp;center="+map_lat+","+map_lng+"&amp;zoom="+map_zoom+"&amp;size="+c+"x"+a+"&amp;markers=size:mid|"+marker_latlng.lat()+","+marker_latlng.lng()+"&amp;sensor=false') no-repeat center;\" />"}else{var f='<img src="https://maps-api-ssl.google.com/maps/api/staticmap?center='+saved_location[0][1]+","+saved_location[0][2]+"&zoom="+saved_location[0][0]+"&size="+c+"x"+a+'&sensor=false" editor_component="soo_google_map" width="'+c+'" height="'+a+'" style="width:'+c+"px;height:"+a+"px;border:2px dotted #FF0033;background:url('"+request_uri+"modules/editor/components/soo_google_map/tpl/component.png') no-repeat center;\"";f+=' location_no="'+saved_location.length+'"';for(var b=0;b<saved_location.length;b++){f+=" map_zoom"+b+'="'+saved_location[b][0]+'"';f+=" map_lat"+b+'="'+saved_location[b][1]+'"';f+=" map_lng"+b+'="'+saved_location[b][2]+'"';f+=" marker_lat"+b+'="'+saved_location[b][3]+'"';f+=" marker_lng"+b+'="'+saved_location[b][4]+'"';saved_location[b][5]=saved_location[b][5].replace(/</g,"[[STS[[");saved_location[b][5]=saved_location[b][5].replace(/>/g,"]]STS]]");saved_location[b][5]=saved_location[b][5].replace(/=/g,"[[STS_EQ]]");f+=" ment"+b+'="'+saved_location[b][5]+'"'}f+=" />"}opener.editorFocus(opener.editorPrevSrl);var d=opener.editorGetIFrame(opener.editorPrevSrl);opener.editorReplaceHTML(d,f);opener.editorFocus(opener.editorPrevSrl);window.close()}jQuery(document).ready(function(){getGoogleMap()});